<?xml version="1.0" encoding="windows-1251"?>
<ds:metadata xmlns:dt="urn:schemas-microsoft-com:datatypes" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0" xmlns:it-i="http://www.croc.ru/Schemas/IncidentTracker/Interface/1.0" xmlns:itds="http://www.croc.ru/Schemas/IncidentTracker/Data/1.0" xmlns:ie="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0/Extension" xmlns:it-sec="http://www.croc.ru/Schemas/IncidentTracker/Security/1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0 x-net-interface-schema.xsd http://www.croc.ru/Schemas/IncidentTracker/Interface/1.0 it-special-interface-schema.xsd http://www.croc.ru/Schemas/IncidentTracker/Data/1.0 it-special-data-schema.xsd http://www.croc.ru/Schemas/IncidentTracker/Security/1.0 it-special-security-schema.xsd http://www.croc.ru/Schemas/XmlFramework/Interface/1.0/Extension x-net-interface-extension-schema.xsd" xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
	<i:objects-tree n="Company" t="Структура компаний" it-i:menu-data-provider="Croc.IncidentTracker.Trees.CompanyTreeMenuDataProvider,Croc.IncidentTracker.Commands" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0" xmlns:it-i="http://www.croc.ru/Schemas/IncidentTracker/Interface/1.0">
		<i:client-script>s-tree-Company.vbs</i:client-script>
		<i:filter-as-editor ot="FilterCompanyTree" height="60" />
		<i:tree-struct>
			<!-- Меню для пустой иерархии -->
			<i:empty-tree-menu>
				<i:menu>
					<i:caption />
					<i:menu-item action="DoCreate" t="Создать организацию-владельца системы">
						<i:params>
							<i:param n="ObjectType">Organization</i:param>
							<i:param n="URLPARAMS">.Home=1</i:param>
						</i:params>
					</i:menu-item>
				</i:menu>
			</i:empty-tree-menu>
			<i:tree-level ref="OrganizationWithDepartments" />
		</i:tree-struct>
	</i:objects-tree>
	<i:tree-level n="OrganizationWithDepartments" ot="Organization" alias="o" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
			<ds:cmd-text>
        <![CDATA[
				SELECT 
					o.ObjectID, 
					o.[Name] AS TITLE, 
					@@ISLEAF,
					CASE WHEN o.Home = 1 THEN 'home' END AS ICON_SELECTOR,
					o.Home AS IsHomeOrg
				FROM 
					dbo.Organization o WITH(NOLOCK)
				WHERE
					(
						(	o.Home = 1 OR
							EXISTS( SELECT 1 FROM dbo.Department d WITH(NOLOCK) WHERE d.Organization = o.ObjectID ) OR 
							EXISTS( SELECT 1 FROM dbo.Employee emp WITH(NOLOCK) WHERE emp.Organization = o.ObjectID ) OR
							o.StructureHasDefined = 1
						) AND SEARCH_CONDITIONS
					)
					OR
					(o.ObjectID = @@OBJECT_ID)
			]]>
      </ds:cmd-text>
			<ds:order-by>o.Home DESC, o.Name</ds:order-by>
		</ds:data-source>
		<!-- 2-ой уровень: Отделы, подчиненные Организации -->
		<i:tree-level ot="Department" alias="d" recursive="1">
			<!-- Важно: алиас таблицы Organization должен не совпадать с алиасом родительского уровня (для корректной работы @@ISLEAF род. уровня) -->
			<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
				<ds:cmd-text>
          <![CDATA[
					SELECT
						d@@RC.ObjectID, 
						d@@RC.Name AS TITLE, 
						@@ISLEAF,
						d@@RC.Organization AS OrgID,
						oo.Home AS IsHomeOrg,
						CASE d@@RC.[IsArchive] WHEN 0 THEN 'Actual' ELSE 'Archive' END AS ICON_SELECTOR
					FROM
						dbo.Department d@@RC WITH(NOLOCK) 
						JOIN dbo.Organization oo WITH(NOLOCK) ON d@@RC.Organization = oo.ObjectID
					WHERE
						(@@RecursiveExp(d@@RC.Parent, d@@RC.Organization = @@ParentID(1) AND d@@RC.Parent IS NULL) AND SEARCH_CONDITIONS)
						OR 
						(d@@RC.ObjectID = @@OBJECT_ID)
				]]>
        </ds:cmd-text>
				<ds:order-by>d@@RC.Name</ds:order-by>
				<ds:params>
					<ds:param n="ShowArchive" vt="boolean">
						<ds:param-selector op="equal" value="0">(d@@RC.IsArchive = 0)</ds:param-selector>
						<ds:param-selector op="equal" value="1">1=1</ds:param-selector>
					</ds:param>
				</ds:params>
			</ds:data-source>
			<i:tree-level ref="DirectionFolderUnderDepartment" />
			<i:tree-level ref="EmployeeUnderDepartment" />
		</i:tree-level>
		<!-- 2-ой уровень: Сотрудники без ссылки на Департамент -->
		<i:tree-level ot="Employee" alias="emp">
			<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
				<ds:cmd-text>
          <![CDATA[
					SELECT 
						emp.ObjectID, 
						emp.LastName + ' ' + emp.FirstName + IsNull(' ' + emp.MiddleName, '') As TITLE, 
						@@ISLEAF,
						CASE 
							WHEN NOT emp.WorkEndDate IS NULL THEN 'Archived' 
							WHEN NOT emp.TemporaryDisability = 0 THEN 'TemporaryDisability'
						END AS ICON_SELECTOR,
						emp.Organization AS OrganizationID
					FROM 
						dbo.Employee emp WITH(NOLOCK)
					WHERE 
						(emp.Organization = @@ParentID(1) AND emp.Department IS NULL AND SEARCH_CONDITIONS)
						OR 
						(emp.ObjectID = @@OBJECT_ID)
				]]>
        </ds:cmd-text>
				<ds:order-by>emp.LastName, emp.FirstName, emp.MiddleName</ds:order-by>
				<ds:params>
					<ds:param n="ShowArchive" vt="boolean">
						<ds:param-selector op="equal" value="0">(WorkEndDate IS NULL) AND (TemporaryDisability = 0)</ds:param-selector>
						<ds:param-selector op="equal" value="1">1=1</ds:param-selector>
					</ds:param>
					<ds:param n="IgnoreEmployeeID" vt="uuid" array="1">
						<ds:param-selector op="in">emp.ObjectID NOT</ds:param-selector>
					</ds:param>
				</ds:params>
			</ds:data-source>
		</i:tree-level>
	</i:tree-level>
	<!-- Виртуальный узел "Направления" под Отделом -->
	<i:tree-level n="DirectionFolderUnderDepartment" ot="DirectionsFolder" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
			<ds:cmd-text>
        <![CDATA[
				SELECT 
					NULL AS ObjectID, 
					'Направления' AS TITLE, 
					@@ISLEAF,
					cast(@@ParentID(1) as uniqueidentifier) AS DepartmentID
				WHERE 
					(EXISTS (
						SELECT 1 FROM dbo.Direction WITH(NOLOCK) 
						WHERE Department = @@ParentID(1)
					) AND SEARCH_CONDITIONS )
					OR
					NULL = @@OBJECT_ID
			]]>
      </ds:cmd-text>
		</ds:data-source>
		<i:level-menu>
			<i:menu>
				<i:caption />
				<i:menu-item action="DoCreate" t="Создать направление">
					<i:params>
						<i:param n="ObjectType">Direction</i:param>
						<i:param n="URLPARAMS">.Department=@@DepartmentID</i:param>
						<i:param n="RefreshFlags">TRM_CHILDS+TRM_NODE</i:param>
					</i:params>
				</i:menu-item>
			</i:menu>
		</i:level-menu>
		<!-- Уровень Направления -->
		<i:tree-level ot="Direction" alias="d" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
			<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
				<ds:cmd-text>
          <![CDATA[
					SELECT 
						d.ObjectID, 
						d.Name As TITLE, 
						@@ISLEAF,
						CASE d.[IsObsolete] WHEN 0 THEN 'actual' ELSE 'obsolete' END AS ICON_SELECTOR,
						d.Department AS DepartmentID
					FROM 
						dbo.Direction d WITH(NOLOCK)
					WHERE 
						(d.Department = @@ParentID(2) AND SEARCH_CONDITIONS)
						OR 
						(d.ObjectID = @@OBJECT_ID)
				]]>
        </ds:cmd-text>
				<ds:order-by>d.Name</ds:order-by>
			</ds:data-source>
			<i:level-menu>
				<i:menu>
					<i:caption />
					<i:menu-item action="DoCreate" t="Создать направление">
						<i:params>
							<i:param n="URLPARAMS">.Department=@@DepartmentID</i:param>
							<i:param n="RefreshFlags">TRM_NODE</i:param>
						</i:params>
					</i:menu-item>
					<i:menu-item action="DoEdit" t="Редактировать" default="1" />
					<i:menu-item-separ horizontal-line="1" />
					<i:menu-item action="DoDelete" t="Удалить" />
				</i:menu>
			</i:level-menu>
		</i:tree-level>
	</i:tree-level>
	<!-- Уровень Сотрудники под Отделом -->
	<i:tree-level n="EmployeeUnderDepartment" ot="Employee" alias="emp" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
			<ds:cmd-text>
        <![CDATA[
				SELECT 
					emp.ObjectID,
					emp.LastName + ' ' + emp.FirstName + IsNull(' ' + emp.MiddleName, '') As TITLE, 
					@@ISLEAF,
						CASE 
							WHEN NOT emp.WorkEndDate IS NULL THEN 'Archived' 
							WHEN NOT emp.TemporaryDisability = 0 THEN 'TemporaryDisability'
						END AS ICON_SELECTOR,
					emp.Department AS DepartmentID,
					emp.Organization AS OrganizationID
				FROM
					dbo.Employee emp WITH(NOLOCK)
				WHERE 
					(emp.Department = @@ParentID(1) AND SEARCH_CONDITIONS)
					OR 
					(emp.ObjectID = @@OBJECT_ID)
			]]>
      </ds:cmd-text>
			<ds:order-by>emp.LastName, emp.FirstName, emp.MiddleName</ds:order-by>
			<ds:params>
				<ds:param n="ShowArchive" vt="boolean">
					<ds:param-selector op="equal" value="0">(WorkEndDate IS NULL) AND (TemporaryDisability = 0)</ds:param-selector>
					<ds:param-selector op="equal" value="1">1=1</ds:param-selector>
				</ds:param>
				<ds:param n="IgnoreEmployeeID" vt="uuid" array="1">
					<ds:param-selector op="in">emp.ObjectID NOT</ds:param-selector>
				</ds:param>
			</ds:params>
		</ds:data-source>
		<i:level-menu>
			<i:menu>
				<i:caption>@@Title</i:caption>
				<i:menu-item action="DoCreate" hotkey="VK_INS" t="Создать сотрудника">
					<i:params>
						<i:param n="URLPARAMS">.Department=@@DepartmentID&amp;.Organization=@@OrganizationID</i:param>
					</i:params>
				</i:menu-item>
				<i:menu-item action="DoEdit" hotkey="VK_ENTER" t="Редактировать" default="1">
					<i:params>
						<i:param n="RefreshFlags">TRM_NODE</i:param>
					</i:params>
				</i:menu-item>
				<i:menu-item-separ horizontal-line="1" />
				<i:menu-item action="DoDelete" hotkey="VK_DEL" t="Удалить" />
			</i:menu>
		</i:level-menu>
	</i:tree-level>
	<!--
		=======================================================================
		ВЫБОР НАПРАВЛЕНИЙ
	-->
	<i:objects-tree-selector n="Directions" t="Выберите направление" selectable-node-types="Direction" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<i:tree-struct>
			<i:tree-level ot="Department" alias="d" recursive="1">
				<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
					<ds:cmd-text>
            <![CDATA[
						SELECT 
							d@@RC.ObjectID, 
							d@@RC.Name AS TITLE, 
							@@ISLEAF
						FROM 
							dbo.Department d@@RC WITH(NOLOCK)
						WHERE 
							(@@RecursiveExp(d@@RC.Parent, 
								d@@RC.Organization = (SELECT ObjectID FROM dbo.Organization WITH(NOLOCK) WHERE Home=1) AND d@@RC.Parent IS NULL) AND SEARCH_CONDITIONS)
							OR 
							(d@@RC.ObjectID = @@OBJECT_ID)
					]]>
          </ds:cmd-text>
					<ds:order-by>Name</ds:order-by>
				</ds:data-source>
				<i:tree-level ref="DirectionFolderUnderDepartment" />
			</i:tree-level>
		</i:tree-struct>
	</i:objects-tree-selector>
	<!--
		=======================================================================
		ВЫБОР СОТРУДНИКА "родной" компании
	-->
	<i:objects-tree-selector n="FriendlyEmployees" t="Выберите сотрудника" selectable-node-types="Employee" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<i:filter-as-editor ot="FilterCompanyTree" height="60" />
		<i:tree-struct>
			<i:tree-level ot="Department" alias="d" recursive="1">
				<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
					<ds:cmd-text>
            <![CDATA[
						SELECT 
							d@@RC.ObjectID, 
							d@@RC.Name AS TITLE, 
							@@ISLEAF
						FROM 
							dbo.Department d@@RC WITH(NOLOCK)
						WHERE 
							(	@@RecursiveExp( d@@RC.Parent, d@@RC.Organization = (SELECT ObjectID FROM dbo.Organization WITH(NOLOCK) WHERE Home = 1) AND d@@RC.Parent IS NULL) AND SEARCH_CONDITIONS)
							OR 
							(d@@RC.ObjectID = @@OBJECT_ID)
					]]>
          </ds:cmd-text>
					<ds:order-by>Name</ds:order-by>
				</ds:data-source>
				<i:tree-level ot="Employee" alias="emp">
					<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
						<ds:cmd-text>
              <![CDATA[
							SELECT 
								emp.ObjectID,
								LastName + ' ' + FirstName As TITLE, 
								@@ISLEAF,
								CASE 
									WHEN NOT emp.WorkEndDate IS NULL THEN 'Archived' 
									WHEN NOT emp.TemporaryDisability = 0 THEN 'TemporaryDisability'
								END AS ICON_SELECTOR,
								emp.Department AS DepartmentID
							FROM
								dbo.Employee emp WITH(NOLOCK)
							WHERE 
								(emp.Department = @@ParentID(1) AND SEARCH_CONDITIONS)
								OR 
								(emp.ObjectID = @@OBJECT_ID)
						]]>
            </ds:cmd-text>
						<ds:order-by>emp.LastName, emp.FirstName, emp.MiddleName</ds:order-by>
						<ds:params>
							<ds:param n="ShowArchive" vt="boolean">
								<ds:param-selector op="equal" value="0">(WorkEndDate IS NULL) AND (TemporaryDisability = 0)</ds:param-selector>
								<ds:param-selector op="equal" value="1">1=1</ds:param-selector>
							</ds:param>
						</ds:params>
					</ds:data-source>
				</i:tree-level>
			</i:tree-level>
			<!-- Сотрудники без подарзеделений -->
			<i:tree-level ot="Employee" alias="emp">
				<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
					<ds:cmd-text>
            <![CDATA[
						SELECT 
							emp.ObjectID, 
							emp.LastName + ' ' + emp.FirstName As TITLE, 
							1 AS IS_LEAF,
							CASE 
								WHEN NOT emp.WorkEndDate IS NULL THEN 'Archived' 
								WHEN NOT emp.TemporaryDisability = 0 THEN 'TemporaryDisability'
							END AS ICON_SELECTOR,
							emp.Organization AS OrganizationID
						FROM 
							dbo.Employee emp WITH(NOLOCK)
						WHERE 
							(	emp.Organization = (SELECT ObjectID FROM dbo.Organization WITH(NOLOCK) WHERE Home = 1) AND 
								emp.Department IS NULL AND 
								SEARCH_CONDITIONS )
							OR 
							(emp.ObjectID = @@OBJECT_ID)
					]]>
          </ds:cmd-text>
					<ds:order-by>emp.LastName, emp.FirstName, emp.MiddleName</ds:order-by>
					<ds:params>
						<ds:param n="ShowArchive" vt="boolean">
							<ds:param-selector op="equal" value="0">(WorkEndDate IS NULL) AND (TemporaryDisability = 0)</ds:param-selector>
							<ds:param-selector op="equal" value="1">1=1</ds:param-selector>
						</ds:param>
					</ds:params>
				</ds:data-source>
			</i:tree-level>
		</i:tree-struct>
	</i:objects-tree-selector>
	<!--
		=======================================================================
		ВЫБОР СОТРУДНИКА любой компании
	-->
	<i:objects-tree-selector n="AnyEmployees" t="Выберите сотрудника" selectable-node-types="Employee" width="1000" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<i:filter-as-editor ot="FilterCompanyTree" height="60" />
		<i:tree-struct>
			<i:tree-level ref="OrganizationWithDepartments" />
		</i:tree-struct>
	</i:objects-tree-selector>
	<!--
		=======================================================================
		ВЫБОР СОТРУДНИКА из подразделения и подчиненных ему подразделений
	-->
	<i:objects-tree-selector n="DepartmentEmployees" t="Выберите сотрудника" selectable-node-types="Employee" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<i:tree-struct>
			<i:tree-level ot="Department" alias="d" recursive="1">
				<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
					<ds:cmd-text>
            <![CDATA[
						SELECT 
							d@@RC.ObjectID, 
							d@@RC.Name AS TITLE, 
							@@ISLEAF
						FROM 
							dbo.Department d@@RC WITH(NOLOCK)
						WHERE 
							(@@RecursiveExp(d@@RC.Parent, d@@RC.ObjectID = :DepartmentID) AND SEARCH_CONDITIONS)
							OR 
							(d@@RC.ObjectID = @@OBJECT_ID)
					]]>
          </ds:cmd-text>
					<ds:order-by>Name</ds:order-by>
					<ds:params>
						<ds:param n="DepartmentID" vt="uuid" required="1" />
					</ds:params>
				</ds:data-source>
				<i:tree-level ref="EmployeeUnderDepartment" />
			</i:tree-level>
		</i:tree-struct>
	</i:objects-tree-selector>
	<!--
		=======================================================================
		ВЫБОР ОТДЕЛА заданной Организации
	-->
	<i:objects-tree-selector n="DepartmentSelector" t="Выберите отдел" selectable-node-types="Department" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<i:tree-struct>
			<i:tree-level ot="Department" alias="d" recursive="1">
				<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
					<ds:cmd-text>
            <![CDATA[
						SELECT 
							d@@RC.ObjectID, 
							d@@RC.Name AS TITLE, 
							@@ISLEAF
						FROM 
							dbo.Department d@@RC WITH(NOLOCK)
						WHERE 
							(@@RecursiveExp(d@@RC.Parent, d@@RC.Organization = :OrganizationID AND d@@RC.Parent IS NULL) AND SEARCH_CONDITIONS)
							OR 
							(d@@RC.ObjectID = @@OBJECT_ID)
					]]>
          </ds:cmd-text>
					<ds:order-by>Name</ds:order-by>
					<ds:params>
						<ds:param n="OrganizationID" vt="uuid" required="1" />
					</ds:params>
				</ds:data-source>
			</i:tree-level>
		</i:tree-struct>
	</i:objects-tree-selector>
	<!--
		=======================================================================
		ВЫБОР ОТДЕЛА "родной" компании
	-->
	<i:objects-tree-selector n="FriendlyDepartments" t="Выберите отдел" selectable-node-types="Department" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<i:tree-struct>
			<i:tree-level ot="Department" alias="d" recursive="1">
				<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
					<ds:cmd-text>
            <![CDATA[
						SELECT 
							d@@RC.ObjectID, 
							d@@RC.Name AS TITLE, 
							@@ISLEAF
						FROM 
							dbo.Department d@@RC WITH(NOLOCK)
						WHERE 
							(@@RecursiveExp(d@@RC.Parent, d@@RC.Organization = (SELECT ObjectID FROM dbo.Organization WITH(NOLOCK) WHERE Home = 1) AND d@@RC.Parent IS NULL) AND SEARCH_CONDITIONS)
							OR 
							(d@@RC.ObjectID = @@OBJECT_ID)
					]]>
          </ds:cmd-text>
					<ds:order-by>Name</ds:order-by>
				</ds:data-source>
			</i:tree-level>
		</i:tree-struct>
	</i:objects-tree-selector>
	<!--
		=======================================================================
		ВЫБОР ОТДЕЛА любой компании
	-->
	<i:objects-tree-selector n="AnyDepartments" t="Выберите отдел" selectable-node-types="Department" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<i:tree-struct>
			<i:tree-level n="OrganizationWithDepartments" ot="Organization" alias="o" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
				<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
					<ds:cmd-text>
            <![CDATA[
					SELECT 
						o.ObjectID, 
						o.[Name] AS TITLE, 
						@@ISLEAF,
						CASE WHEN o.Home = 1 THEN 'home' END AS ICON_SELECTOR,
						o.Home AS IsHomeOrg
					FROM 
						dbo.Organization o WITH(NOLOCK)
					WHERE
						(
							EXISTS ( SELECT 1 FROM dbo.Department d WITH(NOLOCK) WHERE d.Organization = o.ObjectID )
							AND SEARCH_CONDITIONS
						)
						OR
						(o.ObjectID = @@OBJECT_ID)
					]]>
          </ds:cmd-text>
					<ds:order-by>o.Home DESC, o.Name</ds:order-by>
				</ds:data-source>
				<!-- 2-ой уровень: Отделы, подчиненные Организации -->
				<i:tree-level ot="Department" alias="d" recursive="1">
					<!-- Важно: алиас таблицы Organization должен не совпадать с алиасом родительского уровня (для корректной работы @@ISLEAF род. уровня) -->
					<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
						<ds:cmd-text>
              <![CDATA[
						SELECT
							d@@RC.ObjectID, 
							d@@RC.Name AS TITLE, 
							@@ISLEAF,
							d@@RC.Organization AS OrgID,
							oo.Home AS IsHomeOrg
						FROM
							dbo.Department d@@RC WITH(NOLOCK) 
							JOIN dbo.Organization oo WITH(NOLOCK) ON d@@RC.Organization = oo.ObjectID
						WHERE
							(@@RecursiveExp(d@@RC.Parent, d@@RC.Organization = @@ParentID(1) AND d@@RC.Parent IS NULL) AND SEARCH_CONDITIONS)
							OR 
							(d@@RC.ObjectID = @@OBJECT_ID)
						]]>
            </ds:cmd-text>
						<ds:order-by>d@@RC.Name</ds:order-by>
					</ds:data-source>
				</i:tree-level>
			</i:tree-level>
		</i:tree-struct>
	</i:objects-tree-selector>
	<!--
		=======================================================================
		ВЫБОР Организации ИЛИ Отдела (т.е. любой структурной единицы, для которой определены сотрудники)
	-->
	<i:objects-tree-selector n="AnyOrgsOrDepsWithEmployess" t="Выберите организацию или отдел" selectable-node-types="Organization Department" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<i:tree-struct>
			<i:tree-level n="OrganizationWithDepsOrEmps" ot="Organization" alias="o" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
				<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
					<ds:cmd-text>
            <![CDATA[
						SELECT 
							o.ObjectID, 
							o.[Name] AS TITLE, 
							@@ISLEAF,
							CASE WHEN o.Home = 1 THEN 'home' END AS ICON_SELECTOR,
							o.Home AS IsHomeOrg
						FROM 
							dbo.Organization o WITH(NOLOCK)
						WHERE
							(
								(
									/* явный признак */
									o.StructureHasDefined = 1 OR
									/* косвенные признаки */
									o.Home = 1 OR
									EXISTS( SELECT 1 FROM dbo.Department d WITH(NOLOCK) WHERE d.Organization = o.ObjectID ) OR
									EXISTS( SELECT 1 FROM dbo.Employee emp WITH(NOLOCK) WHERE emp.Organization = o.ObjectID )
								)
								AND SEARCH_CONDITIONS
							)
							OR ( o.ObjectID = @@OBJECT_ID )
					]]>
          </ds:cmd-text>
					<ds:order-by>o.Home DESC, o.Name</ds:order-by>
				</ds:data-source>
				<!-- 2-ой уровень: Отделы, подчиненные Организации -->
				<i:tree-level ot="Department" alias="d" recursive="1">
					<!-- Важно: алиас таблицы Organization должен не совпадать с алиасом родительского уровня (для корректной работы @@ISLEAF род. уровня) -->
					<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
						<ds:cmd-text>
              <![CDATA[
							SELECT
								d@@RC.ObjectID, 
								d@@RC.Name AS TITLE, 
								@@ISLEAF,
								d@@RC.Organization AS OrgID,
								oo.Home AS IsHomeOrg
							FROM
								dbo.Department d@@RC WITH(NOLOCK)
								JOIN dbo.Organization oo WITH(NOLOCK) ON d@@RC.Organization = oo.ObjectID
							WHERE
								(@@RecursiveExp(d@@RC.Parent, d@@RC.Organization = @@ParentID(1) AND d@@RC.Parent IS NULL) AND SEARCH_CONDITIONS)
								OR 
								(d@@RC.ObjectID = @@OBJECT_ID)
						]]>
            </ds:cmd-text>
						<ds:order-by>d@@RC.Name</ds:order-by>
					</ds:data-source>
				</i:tree-level>
			</i:tree-level>
		</i:tree-struct>
	</i:objects-tree-selector>
	<!--
		=======================================================================
		ВЫБОР Организации
	-->
	<i:objects-tree-selector n="OrganizationSelector" width="600" height="800" t="Выберите организацию" selectable-node-types="Organization" off-load="1" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<i:filter-as-editor ot="FilterOrgSelector" height="70" />
		<i:tree-struct>
			<i:tree-level ot="Organization" alias="o">
				<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
					<ds:cmd-text>
            <![CDATA[
						SELECT 
							o.ObjectID, 
							o.Name AS TITLE, 
							@@ISLEAF
						FROM 
							dbo.Organization o WITH(NOLOCK)
						WHERE 
							(o.Parent IS NULL AND SEARCH_CONDITIONS)
							OR 
							(o.ObjectID = @@OBJECT_ID)
					]]>
          </ds:cmd-text>
					<ds:order-by>o.Home DESC, o.Name</ds:order-by>
					<ds:params>
						<ds:param n="Name" vt="string" use-wildcard="implicit-on-end">
							<ds:param-selector op="not-is-null">o.Name LIKE :Name</ds:param-selector>
						</ds:param>
						<ds:param n="CurrentEmployeeID" vt="uuid" />
						<ds:param n="WithOwnActivities" vt="boolean">
							<ds:param-selector op="equal" value="1">
                <![CDATA[
								EXISTS (
									SELECT 1 FROM dbo.Folder f WITH(NOLOCK)
									WHERE
										f.Customer = o.ObjectID AND
										EXISTS (
											SELECT 1 FROM dbo.ProjectParticipant WITH(NOLOCK) 
											WHERE Folder=f.ObjectID AND Employee=:CurrentEmployeeID
										) AND 
										NOT EXISTS (
											SELECT 1 
											FROM dbo.Folder f_i WITH(NOLOCK) 
												JOIN dbo.ProjectParticipant pp_i WITH(NOLOCK) ON f_i.ObjectID=pp_i.Folder AND pp_i.Employee=:CurrentEmployeeID 
											WHERE f_i.LIndex < f.LIndex AND f_i.RIndex > f.RIndex ) 
								)
								]]>
              </ds:param-selector>
						</ds:param>
						<ds:param n="ShowOrgWithoutActivities" vt="boolean">
							<ds:param-selector op="equal" value="0">
                <![CDATA[
								(
									:WithOwnActivities = 1 AND
									EXISTS (
										SELECT 1 FROM dbo.Folder f WITH(NOLOCK)
										WHERE
											f.Customer = o.ObjectID AND
											EXISTS (
												SELECT 1 FROM dbo.ProjectParticipant WITH(NOLOCK) 
												WHERE Folder=f.ObjectID AND Employee=:CurrentEmployeeID
											) AND 
											NOT EXISTS (
												SELECT 1 
												FROM dbo.Folder f_i WITH(NOLOCK) 
													JOIN dbo.ProjectParticipant pp_i WITH(NOLOCK) ON f_i.ObjectID=pp_i.Folder AND pp_i.Employee=:CurrentEmployeeID 
												WHERE f_i.LIndex < f.LIndex AND f_i.RIndex > f.RIndex ) 
									)
								) 
								OR 
								(
									:WithOwnActivities = 0 AND
									EXISTS ( SELECT 1 FROM dbo.Folder f WITH(NOLOCK) WHERE f.Customer = o.ObjectID )
								)
								]]>
              </ds:param-selector>
						</ds:param>
					</ds:params>
				</ds:data-source>
				<i:tree-level ot="Organization" alias="o" recursive="1">
					<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
						<ds:cmd-text>
              <![CDATA[
							SELECT 
								o@@RC.ObjectID, 
								o@@RC.Name AS TITLE, 
								@@ISLEAF
							FROM 
								dbo.Organization o@@RC WITH(NOLOCK)
							WHERE 
								(o@@RC.Parent = @@ParentID(1) AND SEARCH_CONDITIONS)
								OR 
								(o@@RC.ObjectID = @@OBJECT_ID)
						]]>
            </ds:cmd-text>
						<ds:order-by>o@@RC.Name</ds:order-by>
					</ds:data-source>
				</i:tree-level>
			</i:tree-level>
		</i:tree-struct>
	</i:objects-tree-selector>
	<!-- 
		=======================================================================
		Иерархия типов, состояний инцидентов, ролей участников и настройка workflow
	-->
	<i:objects-tree n="IncidentWorkflowManager" it-i:menu-data-provider="Croc.IncidentTracker.Trees.IncidentWorkflowManagerMenuDataProvider,Croc.IncidentTracker.Commands" t="Настройка Workflow инцидентов" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0" xmlns:it-i="http://www.croc.ru/Schemas/IncidentTracker/Interface/1.0">
		<!-- Меню для узлов ирерархии всех уровней -->
		<it-i:default-level-menu it-i:data-provider="Croc.IncidentTracker.Trees.TreeDefaultMenuProvider,Croc.IncidentTracker.Commands" />
		<i:client-script>s-tree-IncidentWorkflow.vbs</i:client-script>
		<i:tree-struct>
			<!-- Меню для пустой иерархии -->
			<i:empty-tree-menu>
				<i:menu>
					<i:caption />
					<i:menu-item action="DoCreate" t="Создать тип инцидента">
						<i:params>
							<i:param n="ObjectType">IncidentType</i:param>
						</i:params>
					</i:menu-item>
				</i:menu>
			</i:empty-tree-menu>
			<!-- Первый (корневой) уровень иерархии -->
			<i:tree-level ot="IncidentType" alias="it">
				<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
					<ds:cmd-text>
            <![CDATA[
						SELECT 
							it.ObjectID, 
							it.Name As TITLE, 
							0 AS IS_LEAF
						FROM 
							dbo.IncidentType it WITH(NOLOCK)
						WHERE_CLAUSE
					]]>
          </ds:cmd-text>
					<ds:order-by>Name</ds:order-by>
				</ds:data-source>
				<!-- Виртуальная папка "Состояния" -->
				<i:tree-level ot="IncidentStatesFolder" virtual="1">
					<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
						<ds:cmd-text>
              <![CDATA[
							SELECT 
								NULL AS ObjectID, 
								'Состояния' AS TITLE, 
								@@ISLEAF,
								cast(@@ParentID(1) as uniqueidentifier) AS IncidentTypeID,
								ISNULL( 
									( SELECT Name FROM dbo.IncidentState WITH(NOLOCK) WHERE IncidentType=@@ParentID(1) AND IsStartState = 1 ),
									'Отсутствует'
								) AS StartState,
								( SELECT COUNT(1) FROM dbo.IncidentState WITH(NOLOCK) WHERE IncidentType=@@ParentID(1) ) AS StatesCount
						]]>
            </ds:cmd-text>
					</ds:data-source>
					<i:level-menu cache-for="nocache">
						<i:menu>
							<i:caption>Состояния типа инцидента</i:caption>
							<i:menu-item action="DoCreate" t="Создать состояние">
								<i:params>
									<i:param n="ObjectType">IncidentState</i:param>
									<i:param n="URLParams">.IncidentType=@@IncidentTypeID</i:param>
									<i:param n="RefreshFlags">TRM_CHILDS+TRM_NODE</i:param>
								</i:params>
							</i:menu-item>
							<i:menu-section t="Информация" n="Info">
								<i:menu-item-info>
									<i:caption>Начальное состояние</i:caption>
									<i:value>@@StartState</i:value>
								</i:menu-item-info>
								<i:menu-item-info>
									<i:caption>Всего состояний</i:caption>
									<i:value>@@StatesCount</i:value>
								</i:menu-item-info>
							</i:menu-section>
						</i:menu>
					</i:level-menu>
					<!-- Состояния текущего типа инцидента -->
					<i:tree-level ot="IncidentState" alias="st">
						<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
							<ds:cmd-text>
                <![CDATA[
								SELECT 
									st.ObjectID AS ObjectID, 
									st.Name AS TITLE, 
									@@ISLEAF,
									st.ObjectID AS ICON_SELECTOR,
									CASE WHEN st.IsStartState = 1 THEN 'Начальное состояние' ELSE '' END AS StartStateLabel,
									st.IncidentType AS IncidentType
								FROM 
									dbo.IncidentState st WITH(NOLOCK)
								WHERE 
									(st.IncidentType = @@ParentID(2) AND SEARCH_CONDITIONS)
									OR
									(st.ObjectID = @@OBJECT_ID)
							]]>
              </ds:cmd-text>
							<ds:order-by>st.OrderIndex, st.Name</ds:order-by>
						</ds:data-source>
						<i:level-menu>
							<i:menu>
								<i:caption>Состояние @@Title</i:caption>
								<i:menu-item action="DoEdit" t="Редактировать состояние" hint="Редактировать выбранное состояние">
									<i:params>
										<i:param n="RefreshFlags">TRM_CHILDS+TRM_NODE+TRM_PARENTNODE</i:param>
									</i:params>
								</i:menu-item>
								<i:menu-item-separ horizontal-line="1" />
								<i:menu-item action="DoCreate" t="Добавить переход из текущего состояния">
									<i:params>
										<i:param n="ObjectType">Transition</i:param>
										<i:param n="URLParams">.From=@@ObjectID</i:param>
										<i:param n="RefreshFlags">TRM_CHILDS+TRM_NODE</i:param>
									</i:params>
								</i:menu-item>
								<i:menu-item action="DoCreate" t="Добавить переход в текущее состояние">
									<i:params>
										<i:param n="ObjectType">Transition</i:param>
										<i:param n="URLParams">.To=@@ObjectID</i:param>
										<i:param n="RefreshFlags">TRM_CHILDS+TRM_NODE</i:param>
									</i:params>
								</i:menu-item>
								<i:menu-item action="DoCreate" t="Создать состояние" hint="Создать состояние для текущего типа инцидента">
									<i:params>
										<i:param n="URLParams">.IncidentType=@@IncidentType</i:param>
										<i:param n="RefreshFlags">TRM_PARENT</i:param>
									</i:params>
								</i:menu-item>
								<i:menu-item-separ horizontal-line="1" />
								<i:menu-item action="DoDelete" hotkey="VK_DEL" t="Удалить состояние" hint="Удалить состояние со всеми переходами из и в него" separator-after="1">
									<i:params>
										<i:param n="RefreshFlags">TRM_PARENT</i:param>
									</i:params>
								</i:menu-item>
								<i:menu-section t="Информация" n="Info">
									<i:menu-item-info>
										<i:caption />
										<i:value>@@StartStateLabel</i:value>
									</i:menu-item-info>
								</i:menu-section>
							</i:menu>
						</i:level-menu>
						<!-- Виртуальная папка "Переходы в данное состояние" -->
						<i:tree-level ot="TransitionsTo" virtual="1">
							<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
								<ds:cmd-text>
                  <![CDATA[
									SELECT 
										NULL AS ObjectID, 
										'Переходы в данное состояние' AS TITLE, 
										@@ISLEAF,
										cast(@@ParentID(1) as uniqueidentifier) AS IncidentStateID,
										cast(@@ParentID(3) as uniqueidentifier) AS IncidentTypeID
								]]>
                </ds:cmd-text>
							</ds:data-source>
							<i:level-menu>
								<i:menu>
									<i:menu-item action="DoCreate" t="Создать переход">
										<i:params>
											<i:param n="ObjectType">Transition</i:param>
											<i:param n="URLParams">.To=@@IncidentStateID</i:param>
											<i:param n="RefreshFlags">TRM_CHILDS+TRM_NODE</i:param>
										</i:params>
									</i:menu-item>
								</i:menu>
							</i:level-menu>
							<!-- Переходы в текущее состояние -->
							<i:tree-level ot="Transition" alias="t">
								<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
									<ds:cmd-text>
                    <![CDATA[
										SELECT 
											t.ObjectID AS ObjectID, 
											st_from.Name AS TITLE, 
											@@ISLEAF,
											t.[From] AS IncidentStateID
										FROM 
											dbo.Transition t WITH(NOLOCK)
											JOIN dbo.IncidentState st_from WITH(NOLOCK) ON t.[From] = st_from.ObjectID
										WHERE 
											(t.[To] = @@ParentID(2) AND SEARCH_CONDITIONS)
											OR
											(t.ObjectID = @@OBJECT_ID)
									]]>
                  </ds:cmd-text>
									<ds:order-by>st_from.Name</ds:order-by>
								</ds:data-source>
								<i:level-menu>
									<i:menu>
										<i:caption>Переход в состояние @@Title</i:caption>
										<i:menu-item action="DoEdit" t="Редактировать переход">
											<i:params>
												<i:param n="RefreshFlags">TRM_PARENT</i:param>
											</i:params>
										</i:menu-item>
										<i:menu-item-separ horizontal-line="1" />
										<i:menu-item action="DoDelete" t="Удалить переход">
											<i:params>
												<i:param n="RefreshFlags">TRM_PARENT</i:param>
											</i:params>
										</i:menu-item>
									</i:menu>
								</i:level-menu>
							</i:tree-level>
						</i:tree-level>
						<!-- Виртуальная папка "Переходы из данного состояния" -->
						<i:tree-level ot="TransitionsFrom" virtual="1">
							<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
								<ds:cmd-text>
                  <![CDATA[
									SELECT 
										NULL AS ObjectID, 
										'Переходы из данного состояния' AS TITLE, 
										@@ISLEAF,
										CAST( @@ParentID(1) AS uniqueidentifier ) AS IncidentStateID,
										CAST( @@ParentID(3) AS uniqueidentifier ) AS IncidentTypeID
								]]>
                </ds:cmd-text>
							</ds:data-source>
							<i:level-menu>
								<i:menu>
									<i:menu-item action="DoCreate" t="Создать переход">
										<i:params>
											<i:param n="ObjectType">Transition</i:param>
											<i:param n="URLParams">.From=@@IncidentStateID</i:param>
											<i:param n="RefreshFlags">TRM_CHILDS+TRM_NODE</i:param>
										</i:params>
									</i:menu-item>
								</i:menu>
							</i:level-menu>
							<!-- Переходы из текущего состояния -->
							<i:tree-level ot="Transition" alias="t">
								<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
									<ds:cmd-text>
                    <![CDATA[
										SELECT 
											t.ObjectID AS ObjectID, 
											st_to.Name AS TITLE, 
											@@ISLEAF,
											t.[From] AS IncidentStateID
										FROM 
											dbo.Transition t WITH(NOLOCK)
											JOIN dbo.IncidentState st_to WITH(NOLOCK) ON t.[To] = st_to.ObjectID
										WHERE 
											(t.[From] = @@ParentID(2) AND SEARCH_CONDITIONS)
											OR
											(t.ObjectID = @@OBJECT_ID)
									]]>
                  </ds:cmd-text>
									<ds:order-by>st_to.Name</ds:order-by>
								</ds:data-source>
								<i:level-menu>
									<i:menu>
										<i:caption>Переход в состояние @@Title</i:caption>
										<i:menu-item action="DoEdit" t="Редактировать переход">
											<i:params>
												<i:param n="RefreshFlags">TRM_PARENT</i:param>
											</i:params>
										</i:menu-item>
										<i:menu-item-separ horizontal-line="1" />
										<i:menu-item action="DoDelete" t="Удалить переход">
											<i:params>
												<i:param n="RefreshFlags">TRM_PARENT</i:param>
											</i:params>
										</i:menu-item>
									</i:menu>
								</i:level-menu>
							</i:tree-level>
						</i:tree-level>
					</i:tree-level>
				</i:tree-level>
				<!-- Виртуальная папка "Роли участников" -->
				<i:tree-level ot="IncidentRolesFolder" virtual="1">
					<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
						<ds:cmd-text>
              <![CDATA[
							SELECT 
								NULL AS ObjectID, 
								'Роли участников' AS TITLE, 
								@@ISLEAF,
								cast(@@ParentID(1) as uniqueidentifier) AS IncidentTypeID
						]]>
            </ds:cmd-text>
					</ds:data-source>
					<i:level-menu>
						<i:menu>
							<i:menu-item action="DoCreate" t="Создать роль исполнителя">
								<i:params>
									<i:param n="ObjectType">UserRoleInIncident</i:param>
									<i:param n="URLParams">.IncidentType=@@IncidentTypeID</i:param>
									<i:param n="RefreshFlags">TRM_CHILDS+TRM_NODE</i:param>
								</i:params>
							</i:menu-item>
						</i:menu>
					</i:level-menu>
					<!-- Роли участников текущего типа -->
					<i:tree-level ot="UserRoleInIncident" alias="ur">
						<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
							<ds:cmd-text>
                <![CDATA[
								SELECT 
									ur.ObjectID AS ObjectID, 
									ur.Name AS TITLE, 
									@@ISLEAF
								FROM 
									dbo.UserRoleInIncident ur WITH(NOLOCK)
								WHERE 
									(ur.IncidentType = @@ParentID(2) AND SEARCH_CONDITIONS)
									OR
									(ur.ObjectID = @@OBJECT_ID)
							]]>
              </ds:cmd-text>
							<ds:order-by>ur.Name</ds:order-by>
						</ds:data-source>
						<!-- Переходы для текущей роли -->
						<i:tree-level ot="Transition" alias="t">
							<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
								<ds:cmd-text>
                  <![CDATA[
									SELECT 
										t.ObjectID AS ObjectID, 
										'Из ''' + st_from.Name + ''' в ''' + st_to.Name + '''' AS TITLE, 
										@@ISLEAF,
										cast(@@ParentID(3) as uniqueidentifier) AS IncidentTypeID
									FROM 
										dbo.Transition t WITH(NOLOCK)
										JOIN dbo.IncidentState st_from WITH(NOLOCK) ON t.[From] = st_from.ObjectID
										JOIN dbo.IncidentState st_to WITH(NOLOCK) ON t.[To] = st_to.ObjectID
									WHERE 
										(t.[Role] = @@ParentID(1) AND SEARCH_CONDITIONS)
										OR
										(t.ObjectID = @@OBJECT_ID)
								]]>
                </ds:cmd-text>
								<ds:order-by>st_from.Name</ds:order-by>
							</ds:data-source>
							<i:level-menu>
								<i:menu>
									<i:menu-item action="DoCreate" t="Создать">
										<i:params>
											<i:param n="ObjectType">Transition</i:param>
											<i:param n="URLParams">IncidentType=@@IncidentTypeID</i:param>
											<i:param n="RefreshFlags">TRM_PARENT</i:param>
										</i:params>
									</i:menu-item>
									<i:menu-item action="DoEdit" t="Редактировать">
										<i:params>
											<i:param n="RefreshFlags">TRM_PARENT</i:param>
										</i:params>
									</i:menu-item>
									<i:menu-item-separ horizontal-line="1" />
									<i:menu-item action="DoDelete" t="Удалить">
										<i:params>
											<i:param n="RefreshFlags">TRM_PARENT</i:param>
										</i:params>
									</i:menu-item>
								</i:menu>
							</i:level-menu>
						</i:tree-level>
					</i:tree-level>
				</i:tree-level>
				<!-- Виртуальная папка "Категории" -->
				<i:tree-level ot="IncidentCategoriesFolder" virtual="1">
					<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
						<ds:cmd-text>
              <![CDATA[
							SELECT 
								NULL AS ObjectID, 
								'Категории' AS TITLE, 
								@@ISLEAF,
								cast(@@ParentID(1) as uniqueidentifier) AS IncidentTypeID
						]]>
            </ds:cmd-text>
					</ds:data-source>
					<i:level-menu>
						<i:menu>
							<i:menu-item action="DoCreate" t="Создать категорию">
								<i:params>
									<i:param n="ObjectType">IncidentCategory</i:param>
									<i:param n="URLParams">.IncidentType=@@IncidentTypeID</i:param>
									<i:param n="RefreshFlags">TRM_CHILDS+TRM_NODE</i:param>
								</i:params>
							</i:menu-item>
						</i:menu>
					</i:level-menu>
					<!-- Категории -->
					<i:tree-level ot="IncidentCategory" alias="ic" recursive="1">
						<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
							<ds:cmd-text>
                <![CDATA[
								SELECT 
									ic@@RC.ObjectID AS ObjectID, 
									ic@@RC.Name AS TITLE, 
									@@ISLEAF,
									ic@@RC.IncidentType AS IncidentTypeID
								FROM 
									dbo.IncidentCategory ic@@RC WITH(NOLOCK)
								WHERE 
									(@@RecursiveExp(ic@@RC.Parent, ic@@RC.IncidentType = @@ParentID(2) AND ic@@RC.Parent IS NULL) AND SEARCH_CONDITIONS)
									OR
									(ic@@RC.ObjectID = @@OBJECT_ID)
							]]>
              </ds:cmd-text>
							<ds:order-by>ic@@RC.Name</ds:order-by>
						</ds:data-source>
					</i:tree-level>
				</i:tree-level>
			</i:tree-level>
		</i:tree-struct>
	</i:objects-tree>
	<!-- 
		=======================================================================
		Виды активностей
	-->
	<i:objects-tree n="ActivityTypes" t="Типы проектных затрат" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<i:tree-struct>
			<!-- Меню для пустой иерархии -->
			<i:empty-tree-menu>
				<i:menu>
					<i:caption />
					<i:menu-item action="DoCreate" t="Создать новый тип Активности">
						<i:params>
							<i:param n="ObjectType">ActivityType</i:param>
						</i:params>
					</i:menu-item>
				</i:menu>
			</i:empty-tree-menu>
			<!--  -->
			<i:tree-level ot="ActivityType" alias="at" recursive="1">
				<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
					<ds:cmd-text>
            <![CDATA[
						SELECT 
							at@@RC.ObjectID, 
							at@@RC.Name As TITLE, 
							@@ISLEAF,
							at@@RC.FolderType,
							CASE WHEN at@@RC.IsTimeLossCause = 1 THEN 'Является причиной списания времени' ELSE '' END AS IsTimeLossCause,
							CASE WHEN at@@RC.AccountRelated = 1 THEN 'Активность в отношении клиента' ELSE '' END AS AccountRelated
						FROM 
							dbo.ActivityType at@@RC WITH(NOLOCK)
						WHERE
							(@@RecursiveExp(at@@RC.Parent) AND SEARCH_CONDITIONS)
							OR 
							(at@@RC.ObjectID = @@OBJECT_ID)
					]]>
          </ds:cmd-text>
					<ds:order-by>Name</ds:order-by>
				</ds:data-source>
				<i:level-menu>
					<i:menu ref="menu-for-ActivityType" />
				</i:level-menu>
			</i:tree-level>
		</i:tree-struct>
	</i:objects-tree>
	<i:menu n="menu-for-ActivityType" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<i:menu-item action="DoCreate" t="Создать новый тип Активности" />
		<i:menu-item action="DoCreate" t="Создать подчиненный тип Активности">
			<i:params>
				<i:param n="URLParams">.Parent=@@ObjectID</i:param>
			</i:params>
		</i:menu-item>
		<i:menu-item action="DoEdit" hotkey="VK_ENTER" t="Изменить">
			<i:params>
				<i:param n="RefreshFlags">TRM_NODE</i:param>
			</i:params>
		</i:menu-item>
		<i:menu-item action="DoDelete" hotkey="VK_DEL" t="Удалить" separator-after="1">
			<i:params>
				<i:param n="RefreshFlags">TRM_TREE</i:param>
			</i:params>
		</i:menu-item>
		<i:menu-section t="Информация">
			<i:menu-item-info>
				<i:caption />
				<i:value>@@IsTimeLossCause</i:value>
			</i:menu-item-info>
			<i:menu-item-info>
				<i:caption />
				<i:value>@@AccountRelated</i:value>
			</i:menu-item-info>
		</i:menu-section>
	</i:menu>
	<!-- 
		=======================================================================
		Состояния инцидентов
	-->
	<i:objects-tree n="IncidentStates" t="Состояния инцидентов" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<i:tree-struct>
			<!-- Первый (корневой) уровень иерархии -->
			<i:tree-level ot="IncidentType" alias="it">
				<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
					<ds:cmd-text>
            <![CDATA[
						SELECT 
							it.ObjectID, 
							it.Name AS TITLE, 
							0 AS IS_LEAF
						FROM 
							dbo.IncidentType it WITH(NOLOCK)
						WHERE_CLAUSE
					]]>
          </ds:cmd-text>
					<ds:order-by>Name</ds:order-by>
				</ds:data-source>
				<!-- Состояния текущего типа инцидента -->
				<i:tree-level ot="IncidentState" alias="st">
					<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
						<ds:cmd-text>
              <![CDATA[
							SELECT 
								st.ObjectID AS ObjectID, 
								st.Name AS TITLE, 
								@@ISLEAF
							FROM 
								dbo.IncidentState st WITH(NOLOCK)
							WHERE 
								(st.IncidentType = @@ParentID(1) AND SEARCH_CONDITIONS)
								OR
								(st.ObjectID = @@OBJECT_ID)
						]]>
            </ds:cmd-text>
						<ds:order-by>st.OrderIndex, st.Name</ds:order-by>
					</ds:data-source>
				</i:tree-level>
			</i:tree-level>
		</i:tree-struct>
	</i:objects-tree>
	<!--
		=======================================================================
		ВЫБОР категории инцидента
	-->
	<i:objects-tree-selector n="IncidentCategorySelector" width="500" t="Выберите категорию" selectable-node-types="IncidentCategory" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<i:tree-struct>
			<!-- Категории -->
			<i:tree-level ot="IncidentCategory" alias="ic" recursive="1">
				<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
					<ds:cmd-text>
            <![CDATA[
						SELECT 
							ic@@RC.ObjectID AS ObjectID, 
							ic@@RC.Name AS TITLE, 
							@@ISLEAF
						FROM 
							dbo.IncidentCategory ic@@RC WITH(NOLOCK)
						WHERE 
							(@@RecursiveExp(ic@@RC.Parent, ic@@RC.IncidentType = @IncidentTypeID AND ic@@RC.Parent IS NULL) AND SEARCH_CONDITIONS)
							OR
							(ic@@RC.ObjectID = @@OBJECT_ID)
					]]>
          </ds:cmd-text>
					<ds:order-by>ic@@RC.Name</ds:order-by>
					<ds:params>
						<ds:param n="IncidentTypeID" vt="uuid" />
					</ds:params>
				</ds:data-source>
			</i:tree-level>
		</i:tree-struct>
	</i:objects-tree-selector>
	<!--
		=======================================================================
		ВЫБОР категории инцидента для переноса
	-->
	<i:objects-tree-selector n="IncidentCategorySelectorForMove" width="500" t="Выберите категорию" xmlns:i="http://www.croc.ru/Schemas/XmlFramework/Interface/1.0">
		<i:tree-struct>
			<i:tree-level ot="IncidentType" alias="it">
				<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
					<ds:cmd-text>
            <![CDATA[
						SELECT 
							it.ObjectID, 
							it.Name AS TITLE, 
							@@ISLEAF
						FROM 
							dbo.IncidentType it WITH(NOLOCK)
						WHERE_CLAUSE
					]]>
          </ds:cmd-text>
					<ds:order-by>Name</ds:order-by>
				</ds:data-source>
				<!-- Категории -->
				<i:tree-level ot="IncidentCategory" alias="ic" recursive="1">
					<ds:data-source xmlns:ds="http://www.croc.ru/Schemas/XmlFramework/Data/1.0">
						<ds:cmd-text>
              <![CDATA[
							SELECT 
								ic@@RC.ObjectID AS ObjectID, 
								ic@@RC.Name AS TITLE, 
								@@ISLEAF
							FROM 
								dbo.IncidentCategory ic@@RC WITH(NOLOCK)
							WHERE 
								(@@RecursiveExp(ic@@RC.Parent, ic@@RC.IncidentType = @@ParentID(1) AND ic@@RC.Parent IS NULL) AND SEARCH_CONDITIONS)
								OR
								(ic@@RC.ObjectID = @@OBJECT_ID)
						]]>
            </ds:cmd-text>
						<ds:order-by>ic@@RC.Name</ds:order-by>
					</ds:data-source>
				</i:tree-level>
			</i:tree-level>
		</i:tree-struct>
	</i:objects-tree-selector>
</ds:metadata>